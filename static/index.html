<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ThinkBot - Adaptive Learning Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-credits {
      margin-top: 8px;
      font-size: 0.9rem;
      opacity: 0.8;
      transition: all 0.3s ease;
    }

    .header-credits:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    .made-with {
      color: rgba(255, 255, 255, 0.8);
      margin-right: 4px;
    }

    .header-name {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .header-name:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }

    .student-management {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .student-selector, .topic-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
    }

    .student-selector label, .topic-selector label {
      color: white;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .student-selector select, .topic-selector select {
      background: white;
      border: none;
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      min-width: 120px;
    }

    .student-selector button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.3s;
    }

    .student-selector button:hover {
      background: #45a049;
    }

    .analytics-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .analytics-section h4 {
      color: #4CAF50;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .student-comparison-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border-bottom: none;
      overflow: hidden;
    }

    .student-comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .student-name {
      font-weight: 600;
      color: #fff;
      font-size: 1rem;
    }

    .student-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .stat-item .stat-value {
      font-weight: 600;
      color: #4CAF50;
      margin-top: 2px;
    }

    .student-comparison-item:last-child {
      border-bottom: none;
    }

    .engagement-insights {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      border-left: 3px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .insights-section {
      margin-bottom: 10px;
    }

    .insights-section:last-child {
      margin-bottom: 0;
    }

    .insights-section strong {
      color: #1a365d;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .insights-section ul {
      margin: 0;
      padding-left: 15px;
      list-style-type: disc;
    }

    .insights-section li {
      color: #2c3e50;
      font-size: 0.85rem;
      margin-bottom: 3px;
      line-height: 1.4;
    }

    .stat-value.positive {
      color: #4ade80;
    }

    .stat-value.negative {
      color: #f87171;
    }

    .engagement-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .engagement-highly_engaged {
      background: #10b981;
      color: white;
    }

    .engagement-engaged {
      background: #3b82f6;
      color: white;
    }

    .engagement-moderate {
      background: #f59e0b;
      color: white;
    }

    .engagement-struggling {
      background: #ef4444;
      color: white;
    }

    .engagement-disengaged {
      background: #6b7280;
      color: white;
    }

    .student-name {
      font-weight: 500;
      color: #2c3e50;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 8px;
      margin-right: 10px;
    }

    .student-stats {
      display: flex;
      gap: 10px;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }

    .stat-item {
      color: #ccc;
    }

    .stat-value {
      color: #4CAF50;
      font-weight: 500;
    }

    .feedback-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .analysis-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .analysis-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      color: #333;
    }

    .analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
    }

    .report-section {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    .profile-info {
      margin-top: 15px;
    }

    .profile-info p {
      margin-bottom: 10px;
    }

    .engagement-badge, .pace-badge {
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .engagement-badge.highly_engaged { background: #4CAF50; color: white; }
    .engagement-badge.engaged { background: #2196F3; color: white; }
    .engagement-badge.moderate { background: #FF9800; color: white; }
    .engagement-badge.struggling { background: #f44336; color: white; }
    .engagement-badge.disengaged { background: #9E9E9E; color: white; }

    .pace-badge.fast { background: #4CAF50; color: white; }
    .pace-badge.medium { background: #2196F3; color: white; }
    .pace-badge.slow { background: #FF9800; color: white; }

    .recommendations {
      margin-top: 15px;
    }

    .recommendations p {
      margin-bottom: 10px;
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }

    .report-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      margin-bottom: 30px;
    }

    .quiz-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .question-section {
      margin-bottom: 30px;
    }

    .question-text {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2c3e50;
      line-height: 1.6;
    }

    .difficulty-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 20px;
    }

    .difficulty-easy { background: #e8f5e8; color: #27ae60; }
    .difficulty-medium { background: #fff3cd; color: #f39c12; }
    .difficulty-hard { background: #f8d7da; color: #e74c3c; }

    .answer-section {
      margin-bottom: 20px;
    }

    .answer-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }

    .answer-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #6c757d;
      border: 2px solid #e9ecef;
    }

    .btn-secondary:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .btn-dashboard {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(79, 70, 229, 0.3);
      margin-left: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-transform: none;
      letter-spacing: 0.3px;
    }

    .btn-dashboard:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.4);
      background: linear-gradient(135deg, #4338ca 0%, #6d28d9 50%, #db2777 100%);
    }

    .btn-dashboard:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }

    .btn-hint {
      background: #17a2b8;
      color: white;
    }

    .btn-hint:hover {
      background: #138496;
      transform: translateY(-1px);
    }

    .feedback-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid #667eea;
    }

    .feedback-text {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #2c3e50;
    }

    /* Enhanced feedback text formatting */
    .feedback-text strong {
      font-weight: 700;
      color: #2c3e50;
    }

    .feedback-text em {
      font-style: italic;
      color: #34495e;
    }

    .feedback-text br {
      margin: 8px 0;
    }

    .feedback-text ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .feedback-text li {
      margin: 5px 0;
      line-height: 1.4;
    }

    .feedback-text p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .feedback-text p:first-child {
      margin-top: 0;
    }

    .feedback-text p:last-child {
      margin-bottom: 0;
    }

    .correct-answer {
      color: #27ae60;
      font-weight: 600;
    }

    .incorrect-answer {
      color: #e74c3c;
      font-weight: 600;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .profile-card, .analytics-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #6c757d;
      font-weight: 500;
    }

    .stat-value {
      font-weight: 600;
      color: #2c3e50;
    }

    .engagement-badge {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .engagement-highly_engaged { background: #d4edda; color: #155724; }
    .engagement-engaged { background: #d1ecf1; color: #0c5460; }
    .engagement-moderate { background: #fff3cd; color: #856404; }
    .engagement-struggling { background: #f8d7da; color: #721c24; }
    .engagement-learning { background: #e2e3e5; color: #383d41; }

    .learning-style-badge {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .learning-style-visual { background: #3b82f6; color: white; }
    .learning-style-auditory { background: #8b5cf6; color: white; }
    .learning-style-kinesthetic { background: #f59e0b; color: white; }
    .learning-style-reading { background: #10b981; color: white; }
    .learning-style-unknown { background: #6b7280; color: white; }

    /* Analytics Modal Styles */
    #analytics-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .analytics-modal-content {
      position: relative;
      background-color: white;
      margin: 2% auto;
      padding: 0;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 95vw;
      max-height: 95vh;
      width: 1200px;
      height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes modalSlideOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 2px solid #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
    }

    .modal-header .close {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .modal-header .close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .analytics-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8fafc;
    }

    .analytics-summary {
      margin-bottom: 25px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
    }

    .summary-card h3 {
      margin: 0 0 15px 0;
      color: #2d3748;
      font-size: 1.1rem;
    }

    .analytics-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .search-box input {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      width: 300px;
      transition: border-color 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-controls {
      display: flex;
      gap: 15px;
    }

    .filter-controls select {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .filter-controls select:focus {
      outline: none;
      border-color: #667eea;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }

    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2d3748;
    }

    .performance-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .performance-high { background: #d4edda; color: #155724; }
    .performance-medium { background: #fff3cd; color: #856404; }
    .performance-low { background: #f8d7da; color: #721c24; }

    .student-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #718096;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 600;
      color: #2d3748;
    }

    .engagement-insights {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      border-left: 3px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .insights-section {
      margin-bottom: 10px;
    }

    .insights-section:last-child {
      margin-bottom: 0;
    }

    .insights-section strong {
      color: #1a365d;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .insights-section li {
      color: #2c3e50;
      font-size: 0.85rem;
      margin-bottom: 3px;
      line-height: 1.4;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .analytics-modal-content {
        width: 95vw;
        height: 95vh;
        margin: 5% auto;
      }

      .summary-cards {
        grid-template-columns: 1fr;
      }

      .analytics-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box input {
        width: 100%;
      }

      .filter-controls {
        justify-content: space-between;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }

      .student-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .analytics-modal-content {
        width: 98vw;
        height: 98vh;
        margin: 1% auto;
      }

      .modal-header {
        padding: 15px;
      }

      .modal-header h2 {
        font-size: 1.2rem;
      }

      .analytics-modal-body {
        padding: 15px;
      }
    }

    /* Performance bars */
    .performance-bars {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .performance-bar {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .bar-label {
      min-width: 120px;
      font-size: 0.9rem;
      color: #4a5568;
    }

    .bar-container {
      flex: 1;
      height: 20px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .bar-fill.high { background: #48bb78; }
    .bar-fill.medium { background: #ed8936; }
    .bar-fill.low { background: #f56565; }

    .bar-value {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
      color: #2d3748;
    }

    .learning-style {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: capitalize;
      background: #e9ecef;
      color: #495057;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .timer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .timer-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #856404;
    }

    .hint-section {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .hint-text {
      color: #0c5460;
      font-weight: 500;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .next-action {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      text-align: center;
    }

    .next-action-text {
      color: #155724;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .quiz-card {
        padding: 20px;
      }

      .card-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .btn-dashboard {
        margin-left: 0;
        align-self: flex-start;
        font-size: 0.8rem;
        padding: 6px 12px;
      }
      
      .student-comparison-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .student-stats {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* Developer Credits Styles */
    .developer-credits {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px 20px;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .developer-credits:hover {
      background: rgba(255, 255, 255, 0.98);
      transform: translateY(-2px);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    }

    .credits-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      font-size: 14px;
    }

    .credits-text {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .credits-label {
      color: #666;
      font-weight: 400;
    }

    .developer-name {
      color: #333;
      font-weight: 600;
      font-size: 15px;
    }

    .credits-links {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .credit-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .credit-link:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .credit-link:active {
      transform: translateY(0) scale(0.95);
    }

    .icon-globe,
    .icon-linkedin,
    .icon-instagram {
      font-style: normal;
      font-size: 16px;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .icon-linkedin {
      color: #0077b5 !important;
      text-shadow: 0 0 3px rgba(0, 119, 181, 0.3);
    }

    .icon-instagram {
      color: #e4405f !important;
      text-shadow: 0 0 3px rgba(228, 64, 95, 0.3);
    }

    /* Mobile responsiveness for credits */
    @media (max-width: 768px) {
      .developer-credits {
        padding: 10px 15px;
      }
      
      .credits-content {
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }
      
      .credits-text {
        justify-content: center;
      }
      
      .credits-links {
        justify-content: center;
      }
      
      .credit-link {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
    }

    /* Mobile responsiveness for analytics */
    @media (max-width: 768px) {
      .student-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .stat-item {
        font-size: 0.8rem;
        padding: 6px 4px;
      }
      
      .engagement-insights {
        font-size: 0.85rem;
        padding: 10px;
      }
      
      .insights-section {
        margin-bottom: 8px;
      }
      
      .insights-section li {
        color: #2c3e50;
        font-size: 0.8rem;
      }
      
      .insights-section strong {
        color: #1a365d;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .student-stats {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      
      .stat-item {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
      }
      
      .insights-section li {
        color: #2c3e50;
        font-size: 0.75rem;
      }
      
      .insights-section strong {
        color: #1a365d;
        font-size: 0.8rem;
      }
    }

    /* Subtle animation for the credits */
    @keyframes creditsFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .developer-credits {
      animation: creditsFadeIn 0.8s ease-out 1s both;
    }

    /* Start Now Button Styles */
    .start-now-section {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      margin: 20px 0;
      border: 2px dashed #dee2e6;
      transition: all 0.3s ease;
    }

    .start-now-section:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #f0f2ff 0%, #e6e9ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .start-now-content h3 {
      color: #2c3e50;
      font-size: 1.5rem;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .start-now-content p {
      color: #6c757d;
      font-size: 1rem;
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .btn-start-now {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .btn-start-now:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
      background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
    }

    .btn-start-now:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-start-now i {
      font-size: 1rem;
    }

    /* Animation for start now button */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .btn-start-now {
      animation: pulse 2s infinite;
    }

    .btn-start-now:hover {
      animation: none;
    }

    /* Start Now Features */
    .start-now-features {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .feature-item {
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #495057;
      font-weight: 500;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
    }

    .feature-item:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      transform: translateY(-2px);
    }

    /* Mobile responsiveness for features */
    @media (max-width: 768px) {
      .start-now-features {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      
      .feature-item {
        width: 100%;
        text-align: center;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß† ThinkBot</h1>
      <p>AI-Powered Adaptive Learning Platform</p>
      <div class="header-credits">
        <span class="made-with">Made with ‚ù§Ô∏è by</span>
        <a href="https://www.adityakasyap.com" target="_blank" class="header-name">Aditya Kasyap</a>
      </div>
      <div class="student-management">
        <div class="student-selector">
          <label for="student-select">Student:</label>
          <select id="student-select" onchange="changeStudent()">
            <option value="">Select Student</option>
          </select>
          <button id="new-student-btn" onclick="showNewStudentForm()">+ New Student</button>
          <button id="clear-data-btn" onclick="clearCurrentStudentData()" style="background: #dc3545; margin-left: 10px;">üóëÔ∏è Clear My Data</button>
        </div>
        <div class="topic-selector">
          <label for="topic-select">Topic:</label>
          <select id="topic-select" onchange="changeTopic()">
            <option value="">All Topics</option>
            <option value="arithmetic">Arithmetic</option>
            <option value="geometry">Geometry</option>
            <option value="algebra">Algebra</option>
            <option value="calculus">Calculus</option>
            <option value="fractions">Fractions</option>
            <option value="exponents">Exponents</option>
            <option value="colors">Colors</option>
            <option value="geography">Geography</option>
          </select>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="quiz-card">
        <div class="question-section">
          <div id="difficulty-badge" class="difficulty-badge"></div>
          <div id="question" class="question-text">Loading question...</div>
        </div>

        <div class="timer" id="timer" style="display: none;">
          <div class="timer-text">Time: <span id="timer-display">0</span>s</div>
        </div>

        <div class="answer-section" id="answer-section" style="display: none;">
          <input type="text" id="answer" class="answer-input" placeholder="Enter your answer..." />
          <div class="button-group">
            <button class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
            <button class="btn btn-hint" onclick="getHint()">Get Hint</button>
            <button class="btn btn-secondary" onclick="skipQuestion()">Skip</button>
            <button class="btn btn-danger" onclick="endQuiz()">End Quiz</button>
          </div>
        </div>

        <!-- Start Now Button - shown when no active quiz session -->
        <div id="start-now-section" class="start-now-section" style="display: none;">
          <div class="start-now-content">
            <h3>üéØ Ready to Start Learning?</h3>
            <p>Begin your personalized quiz session and track your progress!</p>
            <button class="btn btn-primary btn-start-now" onclick="startNow()">
              <i class="fas fa-play"></i> Start Now
            </button>
            <div class="start-now-features">
              <div class="feature-item">üìä Track your progress</div>
              <div class="feature-item">üéØ Adaptive difficulty</div>
              <div class="feature-item">üí° Get instant feedback</div>
            </div>
          </div>
        </div>

        <div class="hint-section" id="hint-section">
          <div class="hint-text" id="hint-text"></div>
        </div>

        <div class="feedback-section" id="feedback-section" style="display: none;">
          <div class="feedback-text" id="feedback-text"></div>
          <div class="next-action" id="next-action" style="display: none;">
            <div class="next-action-text" id="next-action-text"></div>
          </div>
          <div class="feedback-actions" id="feedback-actions" style="display: none;">
            <button id="next-question-btn" onclick="loadNextQuestion()" class="btn btn-primary">
              Next Question ‚Üí
            </button>
            <button id="analyze-btn" onclick="showAnalysis()" class="btn btn-secondary">
              üìä Analyze Answer
            </button>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="profile-card">
          <div class="card-title">üë§ Student Profile</div>
          <div id="profile-content">
            <div class="loading">
              <div class="spinner"></div>
              <div>Loading profile...</div>
            </div>
          </div>
        </div>

        <div class="analytics-card">
          <div class="card-title">
            üë• All Students Analytics 
            <button id="open-analytics-modal" class="btn-dashboard" onclick="openAnalyticsModal()">üìä View Detailed Dashboard</button>
          </div>
          <div id="analytics-content" style="display: none;">
            <div class="loading">
              <div class="spinner"></div>
              <div>Loading analytics...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Modal -->
  <div id="analysis-modal" class="analysis-modal">
    <div class="analysis-content">
      <div class="analysis-header">
        <h3>üìä Answer Analysis</h3>
        <button class="close-btn" onclick="closeAnalysis()">‚úï</button>
      </div>
      <div id="analysis-details"></div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analytics-modal" class="modal">
    <div class="modal-content analytics-modal-content">
      <div class="modal-header">
        <h2>üìä Detailed Analytics Dashboard</h2>
        <span class="close" onclick="closeAnalyticsModal()">&times;</span>
      </div>
      <div class="analytics-modal-body">
        <div class="analytics-summary">
          <div class="summary-cards">
            <div class="summary-card">
              <h3>üìà Class Overview</h3>
              <div id="class-overview-stats"></div>
            </div>
            <div class="summary-card">
              <h3>üéØ Performance Distribution</h3>
              <div id="performance-distribution"></div>
            </div>
          </div>
        </div>
        
        <div class="analytics-controls">
          <div class="search-box">
            <input type="text" id="student-search" placeholder="üîç Search students..." onkeyup="filterStudents()">
          </div>
          <div class="filter-controls">
            <select id="performance-filter" onchange="filterStudents()">
              <option value="all">All Students</option>
              <option value="high">High Performers</option>
              <option value="medium">Medium Performers</option>
              <option value="low">Struggling Students</option>
            </select>
            <select id="sort-by" onchange="sortStudents()">
              <option value="name">Sort by Name</option>
              <option value="accuracy">Sort by Accuracy</option>
              <option value="engagement">Sort by Engagement</option>
              <option value="questions">Sort by Questions</option>
            </select>
          </div>
        </div>
        
        <div class="students-grid" id="students-grid">
          <!-- Student cards will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentQuestion = null;
    let startTime = null;
    let timerInterval = null;
    let answerChanges = 0;
    let hintsUsed = 0;
    let student = null;
    let selectedTopic = '';
    let allStudents = [];
    let analyticsExpanded = false;
    
    // Session tracking
    let sessionStats = {
        questionsAnswered: 0,
        correctAnswers: 0,
        skippedQuestions: 0,
        totalResponseTime: 0,
        sessionStartTime: null
    };
    
    // Report modal state
    let isReportOpen = false;
    
    // Quiz state tracking
    let isQuizActive = false;

    // Initialize the application
    async function init() {
      await loadStudents();
      student = localStorage.getItem('student');
      if (student) {
        document.getElementById('student-select').value = student;
        // Hide quiz interface and show start now section for existing student
        document.getElementById('answer-section').style.display = 'none';
        document.getElementById('start-now-section').style.display = 'block';
        document.getElementById('question').textContent = 'Welcome back! Ready to continue learning?';
        document.getElementById('difficulty-badge').textContent = '';
        document.getElementById('answer').value = '';
        document.getElementById('timer').style.display = 'none';
        await loadProfile();
        await loadAnalytics();
      } else {
        showNewStudentForm();
      }
    }

    // Start Now function - begins a new quiz session
    function startNow() {
      // Hide start now section
      document.getElementById('start-now-section').style.display = 'none';
      
      // Show quiz interface
      document.getElementById('answer-section').style.display = 'block';
      
      // Set quiz as active
      isQuizActive = true;
      
      // Reset session stats for new quiz
      sessionStats = {
        questionsAnswered: 0,
        correctAnswers: 0,
        skippedQuestions: 0,
        totalResponseTime: 0,
        sessionStartTime: null
      };
      
      // Load first question
      loadQuestion();
    }

    // Load a new question
    async function loadQuestion() {
      try {
        showLoading();
        const url = selectedTopic ? 
          `/question?student=${student}&topic=${selectedTopic}` : 
          `/question?student=${student}`;
        const res = await fetch(url);
        currentQuestion = await res.json();
        
        document.getElementById('question').textContent = currentQuestion.question;
        
        // Update difficulty badge
        const badge = document.getElementById('difficulty-badge');
        badge.textContent = currentQuestion.difficulty;
        badge.className = `difficulty-badge difficulty-${currentQuestion.difficulty}`;
        
        // Reset UI
        document.getElementById('answer').value = '';
        document.getElementById('feedback-section').style.display = 'none';
        document.getElementById('hint-section').style.display = 'none';
        document.getElementById('timer').style.display = 'block';
        
        // Hide start now section when quiz is active
        document.getElementById('start-now-section').style.display = 'none';
        
        // Ensure submit button is restored for new question
        const submitBtn = document.querySelector('button[onclick="submitAnswer()"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.display = '';
          submitBtn.textContent = 'Submit Answer';
        }
        
        // Start timer
        startTimer();
        
        // Reset tracking variables
        answerChanges = 0;
        hintsUsed = 0;
        startTime = Date.now();
        
        // Initialize session stats if this is the first question
        if (sessionStats.sessionStartTime === null) {
          sessionStats.sessionStartTime = Date.now();
        }
        
        // Track answer changes
        const answerInput = document.getElementById('answer');
        let lastValue = '';
        
        // Remove any existing event listeners by cloning the element
        const newAnswerInput = answerInput.cloneNode(true);
        answerInput.parentNode.replaceChild(newAnswerInput, answerInput);
        
        // Add fresh event listener
        newAnswerInput.addEventListener('input', () => {
          if (newAnswerInput.value !== lastValue) {
            answerChanges++;
            lastValue = newAnswerInput.value;
          }
        });
        
      } catch (error) {
        console.error('Error loading question:', error);
        alert('Error loading question. Please try again.');
      }
    }

    // Submit answer
    async function submitAnswer() {
      if (!currentQuestion) return;
      
      const answer = document.getElementById('answer').value.trim();
      if (!answer) {
        alert('Please enter an answer.');
        return;
      }
      
      // Disable submit button and show loading state
      const submitBtn = document.querySelector('button[onclick="submitAnswer()"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      
      const responseTime = (Date.now() - startTime) / 1000;
      stopTimer();
      
      try {
      const res = await fetch('/answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student,
            question_id: currentQuestion.id,
            answer,
            response_time: responseTime,
            answer_changes: answerChanges,
            hints_used: hintsUsed
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
      const data = await res.json();
        
        // Update session stats
        sessionStats.questionsAnswered++;
        if (data.correct) {
          sessionStats.correctAnswers++;
        }
        sessionStats.totalResponseTime += responseTime;
        
        showFeedback(data);
        
        // Update profile and analytics immediately
        await loadProfile();
        await loadAnalytics();
        
        // Force refresh detailed analytics if expanded
        if (analyticsExpanded) {
            await loadDetailedAnalytics();
        }
        
      } catch (error) {
        console.error('Error submitting answer:', error);
        alert('Error submitting answer. Please try again.');
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Convert Markdown to HTML for better formatting
    function markdownToHtml(text) {
      return text
        // Bold text **text** -> <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic text *text* -> <em>text</em> (but not if it's part of **)
        .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>')
        // Line breaks
        .replace(/\n/g, '<br>')
        // Bullet points * -> ‚Ä¢
        .replace(/^\* /gm, '‚Ä¢ ')
        // Numbered lists
        .replace(/^\d+\. /gm, (match) => match)
        // Multiple line breaks -> paragraph breaks
        .replace(/(<br>\s*){2,}/g, '</p><p>')
        // Wrap in paragraph tags if not already wrapped
        .replace(/^(?!<p>)(.+)$/gm, '<p>$1</p>')
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '')
        // Clean up paragraphs that only contain <br>
        .replace(/<p><br><\/p>/g, '<br>');
    }

    // Show feedback
    function showFeedback(data) {
      const feedbackSection = document.getElementById('feedback-section');
      const feedbackText = document.getElementById('feedback-text');
      const nextAction = document.getElementById('next-action');
      const nextActionText = document.getElementById('next-action-text');
      const feedbackActions = document.getElementById('feedback-actions');
      
      // Hide/disable submit button during feedback
      const submitBtn = document.querySelector('button[onclick="submitAnswer()"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.style.display = 'none';
      }
      
      feedbackSection.style.display = 'block';
      
      const correctClass = data.correct ? 'correct-answer' : 'incorrect-answer';
      const correctText = data.correct ? '‚úÖ Correct!' : '‚ùå Incorrect';
      
      feedbackText.innerHTML = `
        <div class="${correctClass}">${correctText}</div>
        <div style="margin-top: 15px;">${markdownToHtml(data.feedback)}</div>
      `;
      
      // Show next action
      if (data.next_action) {
        nextAction.style.display = 'block';
        nextActionText.textContent = getNextActionText(data.next_action);
      }
      
      // Show action buttons for manual progression
      feedbackActions.style.display = 'flex';
      
      // Auto-advance after 5 seconds only for correct answers (more time to see analytics)
      if (data.correct) {
        setTimeout(() => {
          loadNextQuestion();
        }, 5000);
      }
      // For wrong answers, wait for manual progression
    }

    // Get hint
    async function getHint() {
      if (!currentQuestion) return;
      
      try {
        // Add cache-busting parameter to ensure fresh hint
        const res = await fetch(`/hint/${currentQuestion.id}?t=${Date.now()}`);
        const data = await res.json();
        
        const hintSection = document.getElementById('hint-section');
        const hintText = document.getElementById('hint-text');
        
        hintText.textContent = data.hint;
        hintSection.style.display = 'block';
        hintsUsed++;
        
      } catch (error) {
        console.error('Error getting hint:', error);
        alert('Error getting hint. Please try again.');
      }
    }

    // Skip question
    async function skipQuestion() {
      if (confirm('Are you sure you want to skip this question?')) {
        // Show loading state immediately
        showLoading();
        
        // Stop current timer
        stopTimer();
        
        // Update session stats
        sessionStats.questionsAnswered++;
        sessionStats.skippedQuestions++;
        sessionStats.totalResponseTime += (Date.now() - startTime) / 1000;
        
        // Submit skip to backend to track it properly
        try {
          const response = await fetch('/answer', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              student: student,
              question_id: currentQuestion.id,
              answer: 'skip',
              response_time: (Date.now() - startTime) / 1000,
              answer_changes: answerChanges,
              hints_used: hintsUsed
            })
          });
          
          if (response.ok) {
            // Load analytics in background without blocking
            loadAnalytics();
          }
        } catch (error) {
          console.error('Error submitting skip:', error);
        }
        
        // Reset tracking variables
        answerChanges = 0;
        hintsUsed = 0;
        
        // Load new question
      loadQuestion();
    }
    }

    // Timer functions
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        document.getElementById('timer-display').textContent = Math.floor(elapsed);
      }, 100);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // Load student profile
    async function loadProfile() {
      try {
        const res = await fetch(`/analytics/${student}`);
        const profile = await res.json();
        
        // Use backend quiz_sessions count
        const quizSessions = profile.quiz_sessions || 0;
        
        document.getElementById('profile-content').innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Name:</span>
            <span class="stat-value">${profile.student_name}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Questions Attempted:</span>
            <span class="stat-value">${profile.total_quizzes}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Quiz Sessions:</span>
            <span class="stat-value">${quizSessions}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Accuracy:</span>
            <span class="stat-value">${profile.accuracy}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${profile.accuracy}%"></div>
          </div>
          <div class="stat-item">
            <span class="stat-label">Learning Style:</span>
            <span class="stat-value learning-style">${profile.learning_style}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Engagement:</span>
            <span class="stat-value engagement-badge engagement-${profile.engagement_level}">${profile.engagement_level.replace('_', ' ')}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pace:</span>
            <span class="stat-value">${profile.learning_pace}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Response Time:</span>
            <span class="stat-value">${profile.average_response_time}s</span>
          </div>
        `;
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    // Load detailed learning style analysis
    async function loadLearningStyleAnalysis(student) {
      try {
        const res = await fetch(`/learning-style/${student}`);
        const analysis = await res.json();
        return analysis;
      } catch (error) {
        console.error('Error loading learning style analysis:', error);
        return null;
      }
    }

    // Load analytics
    async function loadAnalytics() {
      try {
        const res = await fetch('/analytics');
        const analytics = await res.json();
        
        document.getElementById('analytics-content').innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Total Students:</span>
            <span class="stat-value">${analytics.total_students || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">High Performers:</span>
            <span class="stat-value">${analytics.summary?.high_performers || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Need Attention:</span>
            <span class="stat-value">${analytics.summary?.struggling_students || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Avg Accuracy:</span>
            <span class="stat-value">${(analytics.summary?.average_accuracy || 0).toFixed(1)}%</span>
          </div>
        `;
      } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analytics-content').innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Error loading analytics</span>
          </div>
        `;
      }
    }

    // Helper functions
    function showLoading() {
      document.getElementById('question').textContent = 'Loading question...';
      document.getElementById('difficulty-badge').textContent = '';
    }

    function getNextActionText(action) {
      const actions = {
        'encouraged_practice': 'Keep practicing! You\'re doing great!',
        'guided_learning': 'Let\'s work through this step by step.',
        'challenge_mode': 'Ready for a challenge? Let\'s level up!',
        'focused_review': 'Let\'s review this concept together.',
        'accelerated_learning': 'You\'re ready for advanced topics!',
        'reinforcement': 'Let\'s reinforce this concept with more practice.',
        'continue_learning': 'Great job! Let\'s keep learning!'
      };
      return actions[action] || 'Keep learning!';
    }

    // Load all students from localStorage
    async function loadStudents() {
      const students = JSON.parse(localStorage.getItem('allStudents') || '[]');
      allStudents = students;
      const select = document.getElementById('student-select');
      select.innerHTML = '<option value="">Select Student</option>';
      students.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    // Change student
    async function changeStudent() {
      const newStudent = document.getElementById('student-select').value;
      if (newStudent && newStudent !== student) {
        // Stop current timer
        stopTimer();
        
        student = newStudent;
        localStorage.setItem('student', student);
        
        // Reset session stats for new student
        sessionStats = {
          questionsAnswered: 0,
          correctAnswers: 0,
          skippedQuestions: 0,
          totalResponseTime: 0,
          sessionStartTime: null
        };
        
        // Reset quiz state
        isQuizActive = false;
        
        // Reset UI state
        document.getElementById('feedback-section').style.display = 'none';
        document.getElementById('feedback-actions').style.display = 'none';
        document.getElementById('hint-section').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('answer-section').style.display = 'none';
        
        // Show start now section for new student
        document.getElementById('start-now-section').style.display = 'block';
        
        // Clear question area
        document.getElementById('question').textContent = 'Select a student to begin your learning journey!';
        document.getElementById('difficulty-badge').textContent = '';
        document.getElementById('answer').value = '';
        
        await loadProfile();
        await loadAnalytics();
      }
    }

    // Show new student form
    function showNewStudentForm() {
      const name = prompt('Enter your name:');
      if (name && name.trim()) {
        const trimmedName = name.trim();
        if (!allStudents.includes(trimmedName)) {
          allStudents.push(trimmedName);
          localStorage.setItem('allStudents', JSON.stringify(allStudents));
          loadStudents();
        }
        student = trimmedName;
        localStorage.setItem('student', student);
        document.getElementById('student-select').value = student;
        
        // Reset quiz state for new student
        isQuizActive = false;
        
        // Hide quiz interface
        document.getElementById('answer-section').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        
        // Show start now section for new student
        document.getElementById('start-now-section').style.display = 'block';
        
        // Clear question area
        document.getElementById('question').textContent = 'Welcome! Ready to start your learning journey?';
        document.getElementById('difficulty-badge').textContent = '';
        document.getElementById('answer').value = '';
        
        loadProfile();
        loadAnalytics();
      }
    }

    // Change topic
    function changeTopic() {
      selectedTopic = document.getElementById('topic-select').value;
      if (student) {
    loadQuestion();
      }
    }

    // Open analytics modal
    function openAnalyticsModal() {
      const modal = document.getElementById('analytics-modal');
      modal.style.display = 'block';
      loadAnalyticsModalData();
    }

    // Close analytics modal
    function closeAnalyticsModal() {
      const modal = document.getElementById('analytics-modal');
      const content = modal.querySelector('.analytics-modal-content');
      
      // Add close animation
      content.style.animation = 'modalSlideOut 0.3s ease-in forwards';
      
      setTimeout(() => {
        modal.style.display = 'none';
        content.style.animation = 'modalSlideIn 0.3s ease-out';
      }, 300);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const analyticsModal = document.getElementById('analytics-modal');
      if (event.target === analyticsModal) {
        closeAnalyticsModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const analyticsModal = document.getElementById('analytics-modal');
        if (analyticsModal.style.display === 'block') {
          closeAnalyticsModal();
        }
      }
    });

    // Load data for analytics modal
    async function loadAnalyticsModalData() {
      try {
        const res = await fetch('/analytics');
        const analytics = await res.json();
        
        
        // Update class overview
        updateClassOverview(analytics);
        
        // Update performance distribution
        updatePerformanceDistribution(analytics);
        
        // Load students data
        loadStudentsGrid(analytics);
        
      } catch (error) {
        console.error('Error loading analytics modal data:', error);
      }
    }

    // Update class overview stats
    function updateClassOverview(analytics) {
      const container = document.getElementById('class-overview-stats');
      const students = analytics.students || [];
      const summary = analytics.summary || {};
      
      container.innerHTML = `
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-number">${students.length}</div>
            <div class="stat-label">Total Students</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${summary.high_performers || 0}</div>
            <div class="stat-label">High Performers</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${summary.struggling_students || 0}</div>
            <div class="stat-label">Need Attention</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${(summary.average_accuracy || 0).toFixed(1)}%</div>
            <div class="stat-label">Avg Accuracy</div>
          </div>
        </div>
      `;
    }

    // Update performance distribution
    function updatePerformanceDistribution(analytics) {
      const container = document.getElementById('performance-distribution');
      const students = analytics.students || [];
      
      const high = students.filter(s => (s.accuracy || 0) >= 70).length;
      const medium = students.filter(s => (s.accuracy || 0) >= 40 && (s.accuracy || 0) < 70).length;
      const low = students.filter(s => (s.accuracy || 0) < 40).length;
      
      container.innerHTML = `
        <div class="performance-bars">
          <div class="performance-bar">
            <div class="bar-label">High (70%+)</div>
            <div class="bar-container">
              <div class="bar-fill high" style="width: ${(high / students.length * 100) || 0}%"></div>
            </div>
            <div class="bar-value">${high}</div>
          </div>
          <div class="performance-bar">
            <div class="bar-label">Medium (40-69%)</div>
            <div class="bar-container">
              <div class="bar-fill medium" style="width: ${(medium / students.length * 100) || 0}%"></div>
            </div>
            <div class="bar-value">${medium}</div>
          </div>
          <div class="performance-bar">
            <div class="bar-label">Low (<40%)</div>
            <div class="bar-container">
              <div class="bar-fill low" style="width: ${(low / students.length * 100) || 0}%"></div>
            </div>
            <div class="bar-value">${low}</div>
          </div>
        </div>
      `;
    }

    // Load students grid
    function loadStudentsGrid(analytics) {
      const container = document.getElementById('students-grid');
      const students = analytics.students || [];
      container.innerHTML = students.map(student => createStudentCard(student)).join('');
    }

    // Create student card
    function createStudentCard(student) {
      const accuracy = student.accuracy || 0;
      const performance = accuracy >= 70 ? 'high' : accuracy >= 40 ? 'medium' : 'low';
      
      return `
        <div class="student-card" data-name="${student.name || 'Unknown'}" data-accuracy="${accuracy}" data-engagement="${student.engagement_score || 0}" data-questions="${student.total_quizzes || 0}">
          <div class="student-header">
            <div class="student-name">${student.name || 'Unknown Student'}</div>
            <div class="performance-badge performance-${performance}">${performance}</div>
          </div>
          
          <div class="student-stats">
            <div class="stat-item">
              <div class="stat-label">Accuracy</div>
              <div class="stat-value">${accuracy.toFixed(1)}%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Questions</div>
              <div class="stat-value">${student.total_quizzes || 0}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Engagement</div>
              <div class="stat-value">${(student.engagement_score || 0).toFixed(1)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Response Time</div>
              <div class="stat-value">${(student.average_response_time || 0).toFixed(1)}s</div>
            </div>
          </div>
          
          ${student.engagement_insights ? `
            <div class="engagement-insights">
              ${student.engagement_insights.strengths ? `
                <div class="insights-section">
                  <strong>Strengths:</strong>
                  <ul>
                    ${student.engagement_insights.strengths.map(s => `<li>${s}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              ${student.engagement_insights.concerns ? `
                <div class="insights-section">
                  <strong>Concerns:</strong>
                  <ul>
                    ${student.engagement_insights.concerns.map(c => `<li>${c}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              ${student.engagement_insights.recommendations ? `
                <div class="insights-section">
                  <strong>Recommendations:</strong>
                  <ul>
                    ${student.engagement_insights.recommendations.map(r => `<li>${r}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    // Filter students
    function filterStudents() {
      const searchTerm = document.getElementById('student-search').value.toLowerCase();
      const performanceFilter = document.getElementById('performance-filter').value;
      const cards = document.querySelectorAll('.student-card');
      
      cards.forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const accuracy = parseFloat(card.dataset.accuracy);
        
        let show = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm)) {
          show = false;
        }
        
        // Performance filter
        if (performanceFilter !== 'all') {
          if (performanceFilter === 'high' && accuracy < 70) show = false;
          if (performanceFilter === 'medium' && (accuracy < 40 || accuracy >= 70)) show = false;
          if (performanceFilter === 'low' && accuracy >= 40) show = false;
        }
        
        card.style.display = show ? 'block' : 'none';
      });
    }

    // Sort students
    function sortStudents() {
      const sortBy = document.getElementById('sort-by').value;
      const container = document.getElementById('students-grid');
      const cards = Array.from(container.querySelectorAll('.student-card'));
      
      cards.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'accuracy':
            return parseFloat(b.dataset.accuracy) - parseFloat(a.dataset.accuracy);
          case 'engagement':
            return parseFloat(b.dataset.engagement) - parseFloat(a.dataset.engagement);
          case 'questions':
            return parseFloat(b.dataset.questions) - parseFloat(a.dataset.questions);
          default:
            return 0;
        }
      });
      
      cards.forEach(card => container.appendChild(card));
    }

    // Toggle learning style details
    async function toggleLearningStyleDetails() {
      const details = document.getElementById('learning-style-details');
      const button = document.getElementById('toggle-learning-style');
      const content = document.getElementById('learning-style-content');
      
      if (details.style.display === 'none') {
        // Show details
        details.style.display = 'block';
        button.textContent = 'Hide Detailed Analysis';
        
        // Load detailed analysis if not already loaded
        if (content.textContent === 'Loading detailed analysis...') {
          const analysis = await loadLearningStyleAnalysis(student);
          if (analysis) {
            content.innerHTML = generateLearningStyleDetails(analysis);
      } else {
            content.innerHTML = '<p style="color: #f87171;">Error loading learning style analysis</p>';
          }
        }
      } else {
        // Hide details
        details.style.display = 'none';
        button.textContent = 'Show Detailed Analysis';
      }
    }

    // Generate learning style details HTML
    function generateLearningStyleDetails(analysis) {
      const confidenceColors = {
        'high': '#10b981',
        'medium': '#f59e0b', 
        'low': '#f87171'
      };
      
      const confidenceColor = confidenceColors[analysis.confidence] || '#6b7280';
      
      let scoresHtml = '';
      if (analysis.scores && Object.keys(analysis.scores).length > 0) {
        scoresHtml = '<div class="style-scores" style="margin-top: 10px;"><h5>Style Scores:</h5><div class="scores-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">';
        for (const [style, score] of Object.entries(analysis.scores)) {
          const percentage = Math.round(score * 100);
          scoresHtml += `<div class="score-item" style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 4px;"><span style="text-transform: capitalize;">${style}:</span><span style="font-weight: 600;">${percentage}%</span></div>`;
        }
        scoresHtml += '</div></div>';
      }
      
      let recommendationsHtml = '';
      if (analysis.recommendations && analysis.recommendations.length > 0) {
        recommendationsHtml = '<div class="style-recommendations" style="margin-top: 10px;"><h5>Personalized Recommendations:</h5><ul style="margin: 8px 0; padding-left: 20px;">';
        analysis.recommendations.forEach(rec => {
          recommendationsHtml += `<li style="margin: 4px 0; color: #e5e7eb;">${rec}</li>`;
        });
        recommendationsHtml += '</ul></div>';
      }
      
      return `
        <div class="learning-style-analysis">
          <div class="analysis-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0; color: #f3f4f6;">Learning Style Analysis</h5>
            <span class="confidence-badge" style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; background: ${confidenceColor}; color: white;">
              ${analysis.confidence.toUpperCase()} CONFIDENCE
            </span>
          </div>
          <p style="margin: 8px 0; color: #d1d5db; font-size: 0.9rem;">${analysis.reasoning}</p>
          ${scoresHtml}
          ${recommendationsHtml}
        </div>
      `;
    }

    // Load detailed analytics with student comparison
    async function loadDetailedAnalytics() {
      try {
        const res = await fetch('/analytics');
        const analytics = await res.json();
        
        // Class overview
        document.getElementById('class-overview').innerHTML = `
          <div class="stat-row">
            <span class="stat-label">Total Students:</span>
            <span class="stat-value">${analytics.total_students}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">High Performers:</span>
            <span class="stat-value">${analytics.summary.high_performers}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Struggling Students:</span>
            <span class="stat-value">${analytics.summary.struggling_students}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Average Accuracy:</span>
            <span class="stat-value">${analytics.summary.average_accuracy.toFixed(1)}%</span>
          </div>
        `;

        // Student comparison with enhanced engagement metrics
        const comparisonHtml = analytics.students.map(s => `
          <div class="student-comparison-item">
            <div class="student-comparison-header">
            <span class="student-name">${s.name || 'Unknown Student'}</span>
            </div>
            <div class="student-stats">
              <div class="stat-item">
                <span>Accuracy</span>
                <span class="stat-value">${(s.accuracy || 0).toFixed(1)}%</span>
              </div>
              <div class="stat-item">
                <span>Questions</span>
                <span class="stat-value">${s.total_quizzes || 0}</span>
              </div>
              <div class="stat-item">
                <span>Level</span>
                <span class="stat-value">${s.learning_pace || 'Unknown'}</span>
              </div>
              <div class="stat-item">
                <span>Engagement</span>
                <span class="stat-value engagement-badge engagement-${s.engagement_level || 'unknown'}">${(s.engagement_level || 'Unknown').replace('_', ' ')}</span>
              </div>
              <div class="stat-item">
                <span>Score</span>
                <span class="stat-value">${(s.engagement_score || 0).toFixed(1)}</span>
              </div>
              <div class="stat-item">
                <span>Skip Rate</span>
                <span class="stat-value">${(s.skip_rate || 0).toFixed(1)}%</span>
              </div>
              <div class="stat-item">
                <span>Hints</span>
                <span class="stat-value">${(s.hint_dependency || 0).toFixed(1)}%</span>
              </div>
              <div class="stat-item">
                <span>Momentum</span>
                <span class="stat-value ${s.learning_momentum > 0 ? 'positive' : s.learning_momentum < 0 ? 'negative' : ''}">${(s.learning_momentum || 0).toFixed(1)}</span>
              </div>
            </div>
            ${s.engagement_insights ? `
              <div class="engagement-insights">
                <div class="insights-section">
                  <strong>Strengths:</strong>
                  <ul>${(s.engagement_insights.strengths || []).map(strength => `<li>${strength}</li>`).join('')}</ul>
                </div>
                <div class="insights-section">
                  <strong>Concerns:</strong>
                  <ul>${(s.engagement_insights.concerns || []).map(concern => `<li>${concern}</li>`).join('')}</ul>
                </div>
                <div class="insights-section">
                  <strong>Recommendations:</strong>
                  <ul>${(s.engagement_insights.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}</ul>
                </div>
              </div>
            ` : ''}
          </div>
        `).join('');
        
        document.getElementById('student-comparison').innerHTML = comparisonHtml;
      } catch (error) {
        console.error('Error loading detailed analytics:', error);
      }
    }

    // Load next question manually
    async function loadNextQuestion() {
      document.getElementById('feedback-section').style.display = 'none';
      document.getElementById('feedback-actions').style.display = 'none';
      // Restore submit button visibility for the next question
      const submitBtn = document.querySelector('button[onclick="submitAnswer()"]');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.display = '';
        submitBtn.textContent = 'Submit Answer';
      }
      await loadQuestion();
    }

    // Show analysis modal
    function showAnalysis() {
      const modal = document.getElementById('analysis-modal');
      const details = document.getElementById('analysis-details');
      
      // Mark that this is not the end-quiz report
      isReportOpen = false;
      
      details.innerHTML = `
        <h4>Question Analysis</h4>
        <p><strong>Question:</strong> ${currentQuestion.question}</p>
        <p><strong>Your Answer:</strong> ${document.getElementById('answer').value}</p>
        <p><strong>Correct Answer:</strong> ${currentQuestion.answer}</p>
        <p><strong>Explanation:</strong> ${currentQuestion.explanation || 'No explanation available.'}</p>
        <p><strong>Response Time:</strong> ${((Date.now() - startTime) / 1000).toFixed(1)}s</p>
        <p><strong>Keystrokes/Edits:</strong> ${answerChanges}</p>
        <p><strong>Hints Used:</strong> ${hintsUsed}</p>
      `;
      
      modal.style.display = 'flex';
    }

    // Close analysis modal
    function closeAnalysis() {
      document.getElementById('analysis-modal').style.display = 'none';
      // Stop any running timer
      stopTimer();
      // If we closed the end-quiz report, reset the session stats and show start now
      if (isReportOpen) {
        sessionStats = {
          questionsAnswered: 0,
          correctAnswers: 0,
          skippedQuestions: 0,
          totalResponseTime: 0,
          sessionStartTime: null
        };
        isReportOpen = false;
        
        // Hide quiz interface and show start now section after closing report
        document.getElementById('answer-section').style.display = 'none';
        document.getElementById('start-now-section').style.display = 'block';
        document.getElementById('question').textContent = 'Great job! Ready for another quiz session?';
        document.getElementById('difficulty-badge').textContent = '';
        document.getElementById('answer').value = '';
      }
    }

    // End quiz and show comprehensive report
    let isEndingQuiz = false; // Flag to prevent multiple calls

    async function endQuiz() {
      if (isEndingQuiz) return; // Prevent multiple calls
      
      if (confirm('Are you sure you want to end the quiz? You will see a comprehensive report.')) {
        isEndingQuiz = true; // Set flag
        
        // Stop timer
        stopTimer();
        
        // Set quiz as inactive
        isQuizActive = false;
        
        // Hide timer display
        document.getElementById('timer').style.display = 'none';
        
        // Reset UI state
        document.getElementById('feedback-section').style.display = 'none';
        document.getElementById('feedback-actions').style.display = 'none';
        document.getElementById('hint-section').style.display = 'none';
        
        // End quiz session on backend
        await endQuizSession();
        
        // Load final analytics
        await loadProfile();
        await loadAnalytics();
        
        // Show comprehensive report
        showComprehensiveReport();
        
        isEndingQuiz = false; // Reset flag
      }
    }

    // Show comprehensive report modal
    async function showComprehensiveReport() {
      const modal = document.getElementById('analysis-modal');
      const details = document.getElementById('analysis-details');
      
      try {
        // Mark report state
        isReportOpen = true;
        // Get current student analytics for overall context
        const res = await fetch(`/analytics/${student}`);
        const profile = await res.json();
        
        // Calculate session-specific stats
        const totalQuestions = sessionStats.questionsAnswered || 0;
        const correctAnswers = sessionStats.correctAnswers || 0;
        const skippedQuestions = sessionStats.skippedQuestions || 0;
        const accuracyPct = totalQuestions > 0 ? (correctAnswers / totalQuestions * 100) : 0;
        const avgResponseTime = totalQuestions > 0 ? (sessionStats.totalResponseTime / totalQuestions) : 0;
        const sessionDuration = sessionStats.sessionStartTime ? 
          ((Date.now() - sessionStats.sessionStartTime) / 1000 / 60).toFixed(1) : 0; // minutes
        const engagementLevel = profile.engagement_level || 'Unknown';
        const learningPace = profile.learning_pace || 'Unknown';
        
        details.innerHTML = `
          <h3>üìä Session Quiz Report</h3>
          <div class="report-section">
            <h4>üìà This Session Performance</h4>
            <div class="stat-grid">
              <div class="stat-card">
                <div class="stat-number">${totalQuestions}</div>
                <div class="stat-label">Questions Answered</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${correctAnswers}</div>
                <div class="stat-label">Correct Answers</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${skippedQuestions}</div>
                <div class="stat-label">Skipped Questions</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${accuracyPct.toFixed(1)}%</div>
                <div class="stat-label">Session Accuracy</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${avgResponseTime.toFixed(1)}s</div>
                <div class="stat-label">Avg Response Time</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${sessionDuration}m</div>
                <div class="stat-label">Session Duration</div>
              </div>
            </div>
          </div>
          
          <div class="report-section">
            <h4>üéØ Learning Profile</h4>
            <div class="profile-info">
              <p><strong>Engagement Level:</strong> <span class="engagement-badge ${engagementLevel}">${engagementLevel.replace('_', ' ').toUpperCase()}</span></p>
              <p><strong>Learning Pace:</strong> <span class="pace-badge ${learningPace}">${learningPace.toUpperCase()}</span></p>
              <p><strong>Learning Style:</strong> <span class="learning-style-badge learning-style-${profile.learning_style || 'unknown'}">${profile.learning_style || 'Unknown'}</span></p>
            </div>
            <div id="learning-style-details" class="learning-style-details" style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; display: none;">
              <div id="learning-style-content">Loading detailed analysis...</div>
            </div>
            <button id="toggle-learning-style" class="btn-secondary" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8rem;" onclick="toggleLearningStyleDetails()">
              Show Detailed Analysis
            </button>
          </div>
          
          <div class="report-section">
            <h4>üí° Recommendations</h4>
            <div class="recommendations">
              ${generateRecommendations(profile)}
            </div>
          </div>
          
          <div class="report-actions">
            <button class="btn btn-primary" onclick="startNewQuiz()">Start New Quiz</button>
            <button class="btn btn-secondary" onclick="closeAnalysis()">Close Report</button>
          </div>
        `;
        
        modal.style.display = 'flex';
      } catch (error) {
        console.error('Error loading comprehensive report:', error);
        details.innerHTML = `
          <h3>üìä Comprehensive Quiz Report</h3>
          <p>Error loading report data. Please try again.</p>
          <button class="btn btn-secondary" onclick="closeAnalysis()">Close</button>
        `;
        modal.style.display = 'flex';
      }
    }

    // Generate recommendations based on performance
    function generateRecommendations(profile) {
      const accuracy = profile.accuracy || 0;
      const engagement = profile.engagement_level || '';
      const pace = profile.learning_pace || '';
      
      let recommendations = [];
      
      if (accuracy < 0.5) {
        recommendations.push("üìö Focus on fundamental concepts and take your time with each question");
      } else if (accuracy > 0.8) {
        recommendations.push("üöÄ You're doing great! Consider challenging yourself with harder topics");
      }
      
      if (engagement === 'struggling') {
        recommendations.push("üí™ Try breaking down complex problems into smaller steps");
      } else if (engagement === 'highly_engaged') {
        recommendations.push("‚≠ê Keep up the excellent work! Your engagement is impressive");
      }
      
      if (pace === 'slow') {
        recommendations.push("‚è∞ Don't worry about speed - focus on understanding first");
      } else if (pace === 'fast') {
        recommendations.push("üéØ Great speed! Make sure you're not rushing through questions");
      }
      
      if (recommendations.length === 0) {
        recommendations.push("üéâ Keep practicing regularly to maintain your progress!");
      }
      
      return recommendations.map(rec => `<p>${rec}</p>`).join('');
    }

    // Start a new quiz
    function startNewQuiz() {
      closeAnalysis();
      
      // Stop any running timer
      stopTimer();
      
      // Reset session stats for new quiz
      sessionStats = {
        questionsAnswered: 0,
        correctAnswers: 0,
        skippedQuestions: 0,
        totalResponseTime: 0,
        sessionStartTime: null
      };
      
      // Reset quiz state
      isQuizActive = false;
      
      // Reset UI state
      document.getElementById('feedback-section').style.display = 'none';
      document.getElementById('feedback-actions').style.display = 'none';
      document.getElementById('hint-section').style.display = 'none';
      document.getElementById('timer').style.display = 'none';
      document.getElementById('answer-section').style.display = 'none';
      
      // Show start now section
      document.getElementById('start-now-section').style.display = 'block';
      
      // Clear question area
      document.getElementById('question').textContent = 'Ready for another quiz session?';
      document.getElementById('difficulty-badge').textContent = '';
      document.getElementById('answer').value = '';
    }

    let isEndingSession = false; // Flag to prevent multiple API calls

    // End a quiz session on the backend
    async function endQuizSession() {
      if (isEndingSession) return; // Prevent multiple calls
      
      try {
        isEndingSession = true; // Set flag
        
        const response = await fetch(`/end-quiz-session?student=${encodeURIComponent(student)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          // Reload profile to show updated quiz sessions count
          await loadProfile();
        }
      } catch (error) {
        console.error('Error ending quiz session:', error);
      } finally {
        isEndingSession = false; // Reset flag
      }
    }

    // Clear current student data only
    async function clearCurrentStudentData() {
      if (confirm(`This will clear data for ${student} only. Are you sure?`)) {
        try {
          // Clear current student data from server
          const response = await fetch(`/clear-student/${student}`, {
            method: 'DELETE'
          });
          
          if (!response.ok) {
            throw new Error('Failed to clear server data');
          }
          
          // Clear only current student's data from localStorage
          if (student) {
            localStorage.removeItem(`student_${student}`);
            // Remove from allStudents list
            allStudents = allStudents.filter(s => s !== student);
            localStorage.setItem('allStudents', JSON.stringify(allStudents));
            loadStudents();
          }
          student = null;
          document.getElementById('student-select').value = '';
          showNewStudentForm();
          
          alert('Your data has been successfully cleared!');
        } catch (error) {
          console.error('Error clearing data:', error);
          alert('Error clearing data. Please try again.');
        }
      }
    }

    // Clear ALL data (admin function)
    function clearAllData() {
      if (confirm('‚ö†Ô∏è ADMIN: This will clear ALL student data. Are you absolutely sure?')) {
        if (confirm('This action cannot be undone. Continue?')) {
          localStorage.clear();
          allStudents = [];
          student = null;
          document.getElementById('student-select').innerHTML = '<option value="">Select Student</option>';
          document.getElementById('student-select').value = '';
          showNewStudentForm();
        }
      }
    }

    // Initialize when page loads
    init();

    // Track quiz session when user leaves/closes browser
    window.addEventListener('beforeunload', function() {
      // Only track if there's an active quiz session (questions answered > 0)
      if (sessionStats.questionsAnswered > 0 && student) {
        // Use sendBeacon for reliable delivery even when page is closing
        navigator.sendBeacon('/end-quiz-session?student=' + encodeURIComponent(student));
      }
    });
  </script>

  <!-- Developer Credits Footer -->
  <div class="developer-credits">
    <div class="credits-content">
      <div class="credits-text">
        <span class="credits-label">Developed by</span>
        <span class="developer-name">Aditya Kasyap</span>
      </div>
      <div class="credits-links">
        <a href="https://www.adityakasyap.com" target="_blank" class="credit-link" title="Portfolio">
          <i class="fa-solid fa-globe" style="color: #667eea;"></i>
        </a>
                        <a href="https://linkedin.com/in/thekasyap" target="_blank" class="credit-link" title="LinkedIn">
                          <i class="fa-brands fa-linkedin" style="color: #0077b5;"></i>
                        </a>
                        <a href="https://instagram.com/thekasyap" target="_blank" class="credit-link" title="Instagram">
                          <i class="fa-brands fa-instagram" style="color: #ff0505;"></i>
                        </a>
      </div>
    </div>
  </div>
</body>
</html>
